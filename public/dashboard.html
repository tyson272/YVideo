<script>
  let allVideos = [];
  let isAdmin = true; // viewer can still see videos

  async function loadVideos() {
    const stateEl = document.getElementById('stateMessage');
    const grid = document.getElementById('videoGrid');

    stateEl.textContent = 'Loading videosâ€¦';
    grid.innerHTML = '';

    try {
      const res = await fetch('/videos');
      if (!res.ok) {
        window.location.href = '/login.html';
        return;
      }

      const data = await res.json();
      allVideos = data;

      if (!data.length) {
        stateEl.textContent = 'No videos yet.';
        return;
      }

      stateEl.textContent = '';
      renderVideos(data);
    } catch (err) {
      console.error(err);
      stateEl.textContent = 'Error loading videos';
    }
  }

  function renderVideos(videos) {
    const grid = document.getElementById('videoGrid');
    grid.innerHTML = '';

    videos.forEach(v => {
      const fileName = v.name;

      const card = document.createElement('div');
      card.className = 'video-card';

      const videoEl = document.createElement('video');
      videoEl.src = `/stream/${encodeURIComponent(fileName)}`;
      videoEl.controls = true;

      card.appendChild(videoEl);
      grid.appendChild(card);
    });
  }

  function setupSearch() {
    const input = document.getElementById('searchInput');
    input.addEventListener('input', () => {
      const q = input.value.toLowerCase().trim();
      if (!q) {
        renderVideos(allVideos);
        return;
      }
      const filtered = allVideos.filter(v =>
        v.name.toLowerCase().includes(q)
      );
      renderVideos(filtered);
    });
  }

  (function init() {
    setupSearch();
    loadVideos();
  })();
</script>
